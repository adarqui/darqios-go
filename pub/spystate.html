<!DOCTYPE html>
<html>
<head>
<title>Load Average - Last 1 min</title>
<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.6.0"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
	<script src="/pub/app.js" type="text/javascript"></script>
	<link rel="stylesheet" href="/pub/app.css"/>

	<script type="text/javascript">
		$(document).ready(function() {
			var hash = window.location.hash.replace(/#/g,'')
			var arr = hash.split(':')
			var channel = arr[0]
			var path = arr[1]

			/*
			if(path) {
				path = path.replace(/,/g,'/')
			}
			*/
			console.log("path",path)

			var app = new quickApp();

			var init = function() {
			app.Register(channel)
			app.Callback(function(error, channel, message) {
				message = JSON.parse(message)
				var nd = app.GrabSingle(message, path)
				if(typeof nd.data === 'object') {
					nd.data = JSON.stringify(nd.data)
				}
				var txt = nd.host + ':' + nd.data
				if ($('.'+nd.host).length == 0) {
					$('<div class="'+nd.host+'">'+txt+'</div>').appendTo('.log')
				}
				$('.'+nd.host).text(txt)
			})
			app.WS_Init()
			}


			var help = function() {
				$.getJSON("/accounts/get/", function(data,err) {
						var state = data[0].State
						var traverse = function(obj,path,master) {
							var arr = _.keys(obj)
							for (var v in arr) {
								if(path.length != 0) {
									arr[v] = path+"."+arr[v]
								}
								master.push(arr[v])
							}
							for (var v in obj) {
								var new_path = ""
								if(path.length != 0) {
									new_path = path+"."+v
								} else {
									new_path = v
								}
								var obj_branch = obj[v]
								if (typeof obj_branch === 'object' && !(obj_branch instanceof Array)) {
									var res = traverse(obj_branch, new_path,master)
									arr.push(res)
								}
							}
							return arr
						}
						var master=[]
						var res = traverse(state, "",master)
						console.log(res,master)

						for(var v in master) {
							var txt = '<a target="_blank" href="'+app.settings.url+'/pub/spystate.html'+"#state:Data."+master[v]+'">'+master[v]+'</a>'
							$('<div class="'+v+'">'+txt+'</div>').appendTo('.log')
						}
				})
			}

			if (channel == "help") {
				return help()
			} else {
				init()
			}

		});
	</script>
</head>
<body>
	<div class="log"></div>
</body>
</html>
